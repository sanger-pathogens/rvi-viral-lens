nextflow_workflow {

    name "Test workflow RUN_NEXTCLADE"
    script "workflows/RUN_NEXTCLADE.nf"
    workflow "RUN_NEXTCLADE"

    test("Should run without failures") {

        when {
            params {
                test_loc="${projectDir}/tests/test_data/test_nextclade_inputs/"
                nextclade_data_dir="${test_loc}/test_nextclade_db/"

                meta_flu_4 = [
                    id: "12345_1_1.11111"
                    sample_id: "12345_1_1",
                    taxid: 2955291,
                    flu_seg: 4,
                    ref_subtype: "H1N1",
                ]

                flu_4_fa="${projectDir}/tests/test_data/test_nextclade_inputs/H1N1_seg4.fa"

                meta_flu_6 = [
                    id: "12345_1_2.22222"
                    sample_id: "12345_1_2",
                    taxid: 2955291,
                    flu_seg: 6,
                    ref_subtype: "H1N1",
                ]
                flu_6_fa="${projectDir}/tests/test_data/test_nextclade_inputs/H1N1_seg4.fa"


                meta_covid = [
                    id: "12345_2_1.33333"
                    sample_id: "12345_2_1",
                    taxid: 694009,
                    flu_seg: null,
                    ref_subtype: null,
                ]

                covid_fa = "${projectDir}/tests/test_data/test_nextclade_inputs/covid.fa"

                meta_non_data = [
                    id: "12345_3_1.44444"
                    sample_id: "12345_3_1",
                    taxid: 99999999,
                    flu_seg: null,
                    ref_subtype: null,
                ]

                non_data_fa = "${projectDir}/tests/test_data/test_nextclade_inputs/non_data.fa"
            }

            workflow {
                """
                // define inputs of the process here. Example:
                input[0] = Channel.of(
                            tuple(params.meta_flu_4, params.flu_4_fa),
                            tuple(params.meta_flu_6, params.flu_6_fa),
                            tuple(params.meta_covid, params.covid_fa),
                            tuple(params.meta_non_data, params.non_data_fa)
                        )
                """
            }
        }

        then {
            assert workflow.success
            //assert snapshot(process.out).match()
            assert workflow.stdout.contains("No nextclade data on nextclade_data_dir found for 12345_3_1.44444")
        }

    }

}
